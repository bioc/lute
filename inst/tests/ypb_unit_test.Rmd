---
title: "R Notebook"
output: html_notebook
---

```{r}
# dependencies
libv <- c("here", "dplyr", "ggplot2", "gridExtra", "SingleCellExperiment", 
          "SummarizedExperiment", "scran", "lute")
# library(lute)
sapply(libv, library, character.only = TRUE)
```

SCE example data with multiple donors.

```{r}
# get example data
sce <- random_sce()
sce1 <- sce
sce[["donor"]] <- "donor2"
sce1[["donor"]] <- "donor1"
sce <- cbind(sce, sce1)
table(sce[["donor"]])
# append logcounts
sce <- logNormCounts(sce)
sce1 <- logNormCounts(sce1)
```

Make pseudobulk in 2 ways.

```{r}
ypb1 <- ypb_from_sce(sce, "logcounts", "celltype", "donor")
ypb2 <- ypb_from_sce(sce1, "logcounts", "celltype", "donor")
```

Check identity

```{r}
identical(ypb1$donor1, ypb2$sce.pseudobulk)
```

Check assay class

```{r}
class(logcounts(sce))
```

Compare donor1 pseudobulk results

```{r}
dfp <- data.frame(ypb.sce.combined = ypb1[,"donor1"],
                  ypb.sce.donor1 = ypb2[,1])
ggplot(dfp, aes(x = ypb.sce.combined, y = ypb.sce.donor1)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0)
```

# Test multi region brain data

```{r}
# mrb sce path
sce.mrb.path <- here("deconvo_method-paper", "outputs", "01_prepare-datasets", "sce-mrb_dlpfc.rda")
sce <- get(load(sce.mrb.path))
# convert assays to matrices
logcounts(sce) <- as.matrix(logcounts(sce))
# get ypb objects
ypb3 <- ypb_from_sce(sce, "logcounts", "k2", "donor")
ypb1 <- ypb_from_sce(sce[,donor1.filter], "logcounts", "k2", "donor")
# compare
identical(ypb1[,1], ypb3[,"donor1"])
```
