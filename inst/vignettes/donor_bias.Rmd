---
title: "donor_bias"
author: "Sean Maden"
date: "2022-12-21"
output:
  pdf_document: default
  html_document: default
---

This vignette walks through a series of deconvolution analyses evaluating the 
impact of between-donor variations on results.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggplot2", "GGally")
sapply(libv, library, character.only = T)
```

# Experiment series 1: ndonors = 2

Let's run a series of experiments keeping `ndonor = 2`. We start with the simplest
example of `k = 2` types and `G = 2` total markers, one for each type. We will
vary the offset from small (2) to medium (5) to large (10). This offset magnitude
should be proportional to observed between-donor variances.

```{r}
ndonor = 2
gindexv = c(1, 2)
offsetv <- c(2, 5, 10)
num.sim <- 50
lexpt <- lapply(offsetv, function(offi){
  title.append <- paste0("Offset = ", offi, "\n")
  donor_marker_experiment(gindexv = c(1,2), num.sim = num.sim, ndonor = ndonor,
                          plot.title.append = title.append,
                          sd.offset.pos = offi,
                          sd.offset.neg = offi)
})
names(lexpt) <- paste0("offset:", offsetv)
```

## Randomized marker data

```{r}
knitr::kable(lexpt$`offset:2`$marker.table, align = "c")
knitr::kable(lexpt$`offset:5`$marker.table, align = "c")
knitr::kable(lexpt$`offset:10`$marker.table, align = "c")
```

## Marker bias plots

### PC1 vs. PC2 of donor bias

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
```

### PC1 vs. PC2 of donor, marker variances

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
```

### Screeplots, PCA by donor

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$screeplot
lexpt$`offset:5`$lpca.markers$pca.bydonor$screeplot
lexpt$`offset:10`$lpca.markers$pca.bydonor$screeplot
```

### Screeplots, PCA by donor;type

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$screeplot
lexpt$`offset:5`$lpca.markers$pca.bydonortype$screeplot
lexpt$`offset:10`$lpca.markers$pca.bydonortype$screeplot
```

## Deconvolution results -- all tests

### Results table

```{r}
# get all results
dfres <- do.call(rbind, lapply(offsetv, function(offi){
  lres <- lexpt[grepl(paste0("offset:",offi,"$"), names(lexpt))][[1]]$decon.results
  dfresi <- do.call(rbind, lapply(lres, function(resi){resi$dfres}))
  dfresi <- as.data.frame(dfresi)
  dfresi$offset <- offi
  dfresi
}))
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset)
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Deconvolution results -- without S transformations

### Results table

```{r}
dfres.all <- dfres
dfres <- dfres.all[dfres.all$zs_transform==FALSE,]
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset)
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Deconvolution results -- with S transformations

```{r}
dfres <- dfres.all[dfres.all$zs_transform==TRUE,]
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Experiment series 1: ndonors = 10

Building on the simple 2-donors case above, we now simulate 10 donors with the 
same progression in random offset increase.

```{r}
ndonor = 10
gindexv = c(1, 2)
offsetv <- c(2, 5, 10)
num.sim <- 50
lexpt <- lapply(offsetv, function(offi){
  title.append <- paste0("Offset = ", offi, "\n")
  donor_marker_experiment(gindexv = c(1,2), num.sim = num.sim, ndonor = ndonor,
                          plot.title.append = title.append,
                          sd.offset.pos = offi,
                          sd.offset.neg = offi)
})
names(lexpt) <- paste0("offset:", offsetv)
```

## Marker bias plots

### PC1 vs. PC2 of donor bias

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
```

### PC1 vs. PC2 of donor, marker variances

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
```

### Screeplots, PCA by donor

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$screeplot
lexpt$`offset:5`$lpca.markers$pca.bydonor$screeplot
lexpt$`offset:10`$lpca.markers$pca.bydonor$screeplot
```

### Screeplots, PCA by donor;type

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$screeplot
lexpt$`offset:5`$lpca.markers$pca.bydonortype$screeplot
lexpt$`offset:10`$lpca.markers$pca.bydonortype$screeplot
```


## Deconvolution results -- all tests

### Results table

```{r}
# get all results
dfres <- do.call(rbind, lapply(offsetv, function(offi){
  lres <- lexpt[grepl(paste0("offset:",offi,"$"), names(lexpt))][[1]]$decon.results
  dfresi <- do.call(rbind, lapply(lres, function(resi){resi$dfres}))
  dfresi <- as.data.frame(dfresi)
  dfresi$offset <- offi
  dfresi
}))
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset)
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Deconvolution results -- without S transformations

### Results table

```{r}
dfres.all <- dfres
dfres <- dfres.all[dfres.all$zs_transform==FALSE,]
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset)
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Deconvolution results -- with S transformations

```{r}
dfres <- dfres.all[dfres.all$zs_transform==TRUE,]
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Compare low and high donor variances

## Make a new pseudobulked sample with no offset

We start by generating a pseudobulk sample `Ypb` by simulating marker data for a
single donor. For this, we need to specify the `gindexv` and `sd.offset...` 
arguments.

```{r}
# get decon results
# note: we need to use the same pseudobulked Y data in each case.
# make the ypb from sim data with high donor variances
set.seed(0)
ndonor <- 1
gindexv <- c(1, 2)
offseti <- 0
# get random marker data
df <- rand_donor_marker_table(ndonor = ndonor, gindexv = gindexv,
                              sd.offset.pos = offseti, sd.offset.neg = offseti)
```

We take the first column in `df`, titled `"donor1"`, as the simulated marker 
data.

```{r}
Z <- matrix(df[,"donor1"], nrow = 2)
```

Now make the new pseudobulked sample `Ypb` using the marker data and by setting
the true proportions `P` as 0.75 for type1 and 0.25 for type2.

```{r}
# make new pseudobulk sample
P <- c(0.25, 0.75)
Ypb <- t(t(P) %*% t(Z)) 
```

## Get predictions with low donor offset

To predict the proportions using the 

```{r}
ndonor = 10
gindexv = c(1, 2)
offsetv <- c(1, 1e3)
num.sim <- 1
lexpt <- lapply(offsetv, function(offi){
  title.append <- paste0("Offset = ", offi, "\n")
  donor_marker_experiment(gindexv = c(1,2), num.sim = num.sim, 
                          ndonor = ndonor,
                          plot.title.append = title.append,
                          sd.offset.pos = offi,
                          sd.offset.neg = offi)
})
names(lexpt) <- paste0("offset:", offsetv)
```

```{r}
lexpt$`offset:1`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
```

```{r}
lexpt$`offset:1000`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
```
Get predictions from low variance condition.

```{r}
# simulate donor data
namei <- names(lexpt)[1]
df <- lexpt[[namei]]$marker.table
donor.meanv.unadj <- df[,"donor.combn.all.mean"]
varv <- rowVars(as.matrix(df[,seq(10)])) # var across donors
donor.meanv.adj <- donor.meanv.unadj/varv
# get predictions
# get unadj pval
Zunadj <- matrix(donor.meanv.unadj, nrow = 2)
punadj <- predtype(Z = Zunadj, Y = Ypb, strict_method = "nnls",
                   proportions = TRUE, verbose = TRUE)
# get adj pval
Zadj <- matrix(donor.meanv.adj, nrow = 2)
padj <- predtype(Z = Zadj, Y = Ypb, strict_method = "nnls",
                 proportions = TRUE, verbose = TRUE)
# append results
dfres <- data.frame(ptype = c(rep(punadj, 2), rep(padj, 2)),
                    prop = c(punadj, padj),
                    celltype = c(rep(c("neuron", "non-neuron"), 2)))
dfres$offset <- gsub(".*:", "", namei)
```

Get predictions from high variance condition.

```{r}
# simulate donor data
df <- lexpt$`offset:1000`$marker.table
donor.meanv.unadj <- df[,"donor.combn.all.mean"]
varv <- rowVars(as.matrix(df[,seq(10)])) # var across donors
donor.meanv.adj <- donor.meanv.unadj/varv
# get predictions
# get unadj pval
Zunadj <- matrix(donor.meanv.unadj, nrow = 2)
punadj <- predtype(Z = Zunadj, Y = Ypb, strict_method = "nnls",
                   proportions = TRUE, verbose = TRUE)
# get adj pval
Zadj <- matrix(donor.meanv.adj, nrow = 2)
padj <- predtype(Z = Zadj, Y = Ypb, strict_method = "nnls",
                 proportions = TRUE, verbose = TRUE)
# append results
dfres <- data.frame(ptype = c(rep(punadj, 2), rep(padj, 2)),
                    prop = c(punadj, padj),
                    celltype = c(rep(c("neuron", "non-neuron"), 2)))
dfres$offset <- gsub(".*:", "", namei)
```

Compare outcomes.

```{r}
```

# Use variance-based weighting

We can evaluate the impact of using a variance-based weighting scheme to correct
for donor-specific biases.

First, set the parameters for the experiment. We initially produce a pseudobulked $Y$ object 
with high donor-specific variances for 10 donors.

```{r}
# get decon results
# note: we need to use the same pseudobulked Y data in each case.
# make the ypb from sim data with high donor variances
set.seed(0)
ndonor <- 10
gindexv <- c(1, 2)
offseti <- 1
df <- rand_donor_marker_table(ndonor = ndonor, gindexv = gindexv,
                              sd.offset.pos = offseti, 
                              sd.offset.neg = offseti)
Z <- matrix(df[,ndonor+1], nrow = 2)
P <- c(0.25, 0.75)
Ypb <- t(t(P) %*% t(Z))
```

Next, we simulate a new $Z$ signature matrix from a new randomization with much 
higher variation across donors. Using this and the previously generated 
pseudobulked $Y$ object, we generate our unadjusted predictions.

```{r}
# get the unadjusted predictions from new simulated donor data
set.seed(1)
ndonor <- 10
gindexv <- c(1, 2)
offseti <- 50
df.new <- rand_donor_marker_table(ndonor = ndonor, gindexv = gindexv,
                                  sd.offset.pos = offseti,
                                  sd.offset.neg = offseti)
Zunadj <- matrix(df.new[,ndonor+1], nrow = 2)
punadj <- predtype(Z = Zunadj, Y = Ypb, strict_method = "nnls",
                   proportions = TRUE, verbose = TRUE)
```

Finally we repeat predictions using the same $Z$ signature matrix, but adding
an adjustment on the between-donor variances for each gene in each type. Here,
we simply divide the marker signals by the variances. We use the resulting 
adjusted $Z$ signature matrix to produced our adjusted proportion predictions.

```{r}
# get the adjusted predictions from new simulated donor data
# make adj data -- divide variances
df.adj <- df
varv <- rowVars(as.matrix(df.adj[,seq(ndonor)]))
df.adj[,ndonor+1] <- df.adj[,ndonor+1]/varv
Zadj <- matrix(df.adj[,ndonor+1], nrow = 2)
padj <- predtype(Z = Zadj, Y = Ypb, strict_method = "nnls",
                 proportions = TRUE, verbose = TRUE)
```

Comparing the adjusted and unadjusted data, we see the variance adjustment 
produced accurate predictions whereas the unadjusted predictions are considerably
inaccurate.

```{r}
dft <- data.frame(unadj = punadj, adj = padj, true = P)
knitr::kable(dft, align = "c")
```