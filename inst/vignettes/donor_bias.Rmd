---
title: "donor_bias"
author: "Sean Maden"
date: "2022-12-21"
output: html_document
---

This vignette walks through a series of deconvolution analyses evaluating the 
impact of between-donor variations on results.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggplot2", "GGally")
sapply(libv, library, character.only = T)
```

# Experiment series 1: ndonors = 2

Let's run a series of experiments keeping `ndonor = 2`. We start with the simplest
example of `k = 2` types and `G = 2` total markers, one for each type. We will
vary the offset from small (2) to medium (5) to large (10). This offset magnitude
should be proportional to observed between-donor variances.

```{r}
ndonor = 2
gindexv = c(1, 2)
offsetv <- c(2, 5, 10)
lexpt <- lapply(offsetv, function(offi){
  donor_marker_experiment(gindexv = c(1,2),
                          ndonor = ndonor,
                          mean.offset.pos = offi,
                          mean.offset.neg = offi)
})
names(lexpt) <- paste0("offset:", offsetv)
```

# Randomize donor data

We  start by generating the randomized marker data for `r ndonor` donors.

```{r}
# get simulated marker data
ndonor = 5
dt <- lute::rand_donor_marker_table(ndonor, gindexv = c(1,1,2,2,3,3), ktotal = 3)
dt
```

Next, we generate the combined marker signals from the provided donors.

```{r}
dt$donor.combn.all.mean <- apply(dt[,grepl("donor", colnames(dt))], 1, mean)
dt$donor.combn.all.median <- apply(dt[,grepl("donor", colnames(dt))], 1, median)
```

# Plots -- marker signals

PCA by donor

```{r}
lpca <- pca_bydonor(dt)
lpca$scatterplot.pc1.pc2
lpca$screeplot
```

PCA by donor;type

```{r}
lpca2 <- pca_bydonortype(dt)
lpca2$scatterplot.pc1.pc2
lpca2$pairs
lpca2$screeplot
```
Predictions by donor

```{r}
# get decon args
# prop.val <- 0.1
# lpv <- list(c(prop.val, 1-prop.val))
# lsv <- list(c(1, 10))
lpv <- make_lpv()
num.sim <- length(lpv)
size1 <- 1
size2 <- 100
lsv <- lapply(seq(num.sim), function(ii){c(size1, size2)})

# get params
ndonor <- length(colnames(dt)[grepl("donor", colnames(dt))])
ntype <- length(unique(dt$marker))
# run decon
ld <- lapply(cndv, function(donori){
  cnvf <- c(donori, "type"); dtf <- dt[,cnvf]
  lgvi <- lapply(seq(ntype), function(jj){
    dtf[dtf[,2]==paste0("type", jj),1]
  })
  # rep up to num sim
  lgv.in <- lapply(seq(num.sim), function(ii){lgvi})
  decon_analysis(lgv = lgv.in, lpv = lpv, lsv = lsv)
})
names(ld) <- cndv
```

# Plots -- predictions

```{r}
# get plot data
ztrans <- FALSE
dfp <- do.call(rbind, lapply(ld, function(li){
  dfresi <- li$dfres
  dfresi <- dfresi[dfresi$zs_transform==ztrans,c(1,2)]
  }
))
# dfp$donor <- rownames(dfp)
# make grid of scatterplots, corr
pairs(dfp[,grepl("bias.*", colnames(dfp))])
```
