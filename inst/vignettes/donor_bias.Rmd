---
title: "donor_bias"
author: "Sean Maden"
date: "2022-12-21"
output:
  pdf_document: default
  html_document: default
---

This vignette walks through a series of deconvolution analyses evaluating the 
impact of between-donor variations on results.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggplot2", "GGally")
sapply(libv, library, character.only = T)
```

# Experiment series 1: ndonors = 2

Let's run a series of experiments keeping `ndonor = 2`. We start with the simplest
example of `k = 2` types and `G = 2` total markers, one for each type. We will
vary the offset from small (2) to medium (5) to large (10). This offset magnitude
should be proportional to observed between-donor variances.

```{r}
ndonor = 2
gindexv = c(1, 2)
offsetv <- c(2, 5, 10)
num.sim <- 50
lexpt <- lapply(offsetv, function(offi){
  title.append <- paste0("Offset = ", offi, "\n")
  donor_marker_experiment(gindexv = c(1,2), num.sim = num.sim, ndonor = ndonor,
                          plot.title.append = title.append,
                          sd.offset.pos = offi,
                          sd.offset.neg = offi)
})
names(lexpt) <- paste0("offset:", offsetv)
```

## Randomized marker data

```{r}
knitr::kable(lexpt$`offset:2`$marker.table, align = "c")
knitr::kable(lexpt$`offset:5`$marker.table, align = "c")
knitr::kable(lexpt$`offset:10`$marker.table, align = "c")
```

## Marker bias plots

### PC1 vs. PC2 of donor bias

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
```

### PC1 vs. PC2 of donor, marker variances

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
```

### Screeplots, PCA by donor

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$screeplot
lexpt$`offset:5`$lpca.markers$pca.bydonor$screeplot
lexpt$`offset:10`$lpca.markers$pca.bydonor$screeplot
```

### Screeplots, PCA by donor;type

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$screeplot
lexpt$`offset:5`$lpca.markers$pca.bydonortype$screeplot
lexpt$`offset:10`$lpca.markers$pca.bydonortype$screeplot
```

## Deconvolution results -- all tests

### Results table

```{r}
# get all results
dfres <- do.call(rbind, lapply(offsetv, function(offi){
  lres <- lexpt[grepl(paste0("offset:",offi,"$"), names(lexpt))][[1]]$decon.results
  dfresi <- do.call(rbind, lapply(lres, function(resi){resi$dfres}))
  dfresi <- as.data.frame(dfresi)
  dfresi$offset <- offi
  dfresi
}))
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset)
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Deconvolution results -- without S transformations

### Results table

```{r}
dfres.all <- dfres
dfres <- dfres.all[dfres.all$zs_transform==FALSE,]
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset)
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Deconvolution results -- with S transformations

```{r}
dfres <- dfres.all[dfres.all$zs_transform==TRUE,]
```

### Bias violin plots

```{r}
dfres$offset <- as.factor(dfres$offset)

ggplot(dfres, aes(x = offset, y = bias1)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias1") + theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dfres, aes(x = offset, y = bias2)) + geom_violin(draw_quantiles = 0.5) +
  theme_bw() + ggtitle("Bias2") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Bias scatterplots

```{r}
ggpt <- ggplot(dfres, aes(x = bias1, y = bias2, color = offset)) + geom_point(alpha = 0.5)
ggpt
ggpt + facet_wrap(~offset) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### RMSE violin plot

```{r}
ggplot(dfres, aes(x = offset, y = rmse, fill = offset)) + 
  geom_violin(draw_quantiles = 0.5) + theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Experiment series 1: ndonors = 10

Building on the simple 2-donors case above, we now simulate 10 donors with the 
same progression in random offset increase.

```{r}
ndonor = 10
gindexv = c(1, 2)
offsetv <- c(2, 5, 10)
num.sim <- 50
lexpt <- lapply(offsetv, function(offi){
  title.append <- paste0("Offset = ", offi, "\n")
  donor_marker_experiment(gindexv = c(1,2), num.sim = num.sim, ndonor = ndonor,
                          plot.title.append = title.append,
                          sd.offset.pos = offi,
                          sd.offset.neg = offi)
})
names(lexpt) <- paste0("offset:", offsetv)
```

## Marker bias plots

### PC1 vs. PC2 of donor bias

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonor$scatterplot.pc1.pc2
```

### PC1 vs. PC2 of donor, marker variances

```{r}
lexpt$`offset:2`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:5`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
lexpt$`offset:10`$lpca.markers$pca.bydonortype$scatterplot.pc1.pc2
```