---
title: "donor_bias"
author: "Sean Maden"
date: "2022-12-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

libv <- c("lute")
sapply(libv, library, character.only = T)
```

```{r}
# get simulated marker data
ndonor = 5
dt <- rand_donor_marker_table(ndonor)
dt
```

PCA by donor

```{r}
df.pca <- t(dt[,grepl("donor", colnames(dt))])
rpca <- prcomp(df.pca)
# make scatterplot
dfp <- as.data.frame(rpca$x)
dfp$donor <- rownames(df.pca)
ggplot(dfp, aes(x = PC1, y = PC2, color = donor)) + 
  geom_point(size = 2, alpha = 0.5)
```

PCA by donor;type

```{r}
ntype <- length(unique(dt$type))
catv <- paste0(rep(paste0("donor", seq(ndonor)), each = ntype), ";", 
               rep(paste0("type", seq(ntype)), times = ndonor))
df.pca <- do.call(rbind, lapply(catv, function(cati){
  colfilt <- grepl(gsub(";.*", "", cati), colnames(dt))
  rowfilt <- grepl(gsub(".*;", "", cati), dt$type)
  dtf <- dt[rowfilt, colfilt]
}))
rownames(df.pca) <- catv
rpca <- prcomp(df.pca)
# make scatterplot
dfp <- as.data.frame(rpca$x)
dfp$donor <- gsub(";.*", "", rownames(df.pca))
dfp$type <- gsub(".*;", "", rownames(df.pca))
ggplot(dfp, aes(x = PC1, y = PC2, color = donor, shape = type)) + 
  geom_point(size = 2, alpha = 0.5)
```

Predictions by donor

```{r}
lpv <- list(c(0.5, 0.5))
lsv <- list(c(1, 1))

ndonor <- length(colnames(dt)[grepl("donor", colnames(dt))])
ntype <- length(unique(dt$marker))

ld <- lapply(seq(ndonor), function(ii){
  cnvf <- c(paste0("donor", ii), "type"); dtf <- dt[,cnvf]
  lgvi <- lapply(seq(ntype), function(jj){
    dtf[dtf[,2]==paste0("type", jj),1]
  })
  decon_analysis(lgv = list(lgvi), lpv = lpv, lsv = lsv)
})
names(ld) <- paste0("donor", seq(ndonor))
```
